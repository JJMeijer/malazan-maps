name: Release & Deploy
on:
    push:
        branches:
            - main
        paths:
            - "src/**"
            - "views/**"
            - ".eleventy.js"

jobs:
    release-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup PNPM
              uses: pnpm/action-setup@v4
              with:
                  version: 10
                  cache: true

            - name: Install dependencies
              run: pnpm install

            - name: Automated Version Bump
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  pnpm version patch -m "chore: bump version to %s [skip ci]"
                  git push --follow-tags

            - name: Build
              run: pnpm build:all

            - name: Auth to Google Cloud
              uses: "google-github-actions/auth@v3"
              with:
                  workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.SERVICE_ACCOUNT }}

            - name: Deploy to App Engine
              uses: "google-github-actions/deploy-appengine@v3"
              with:
                  project_id: ${{ secrets.GCP_PROJECT_ID }}
                  working_directory: "./www"
                  promote: true
